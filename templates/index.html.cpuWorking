<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <title>SwarmOps</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: monospace; }
        .card { background-color: #1e1e1e; border: 1px solid #333; transition: border-color 0.3s; }
        .status-dot { height: 10px; width: 10px; background-color: #444; border-radius: 50%; display: inline-block; transition: background-color 0.3s; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .active-dot { background-color: #0f0; box-shadow: 0 0 8px #0f0; }
        .text-neon { color: #00ff00; }
    </style>
</head>
<body class="p-4">
    <div class="container-fluid">
        <h2 class="mb-4">âš¡ SwarmOps <span id="conn-status" class="badge bg-secondary text-dark fs-6">Connecting...</span></h2>
        <div class="row" id="service-list"></div>
    </div>

    <script>
        async function loadData() {
            try {
                const res = await fetch('/api/data');
                const services = await res.json();
                
                document.getElementById('conn-status').className = 'badge bg-success';
                document.getElementById('conn-status').innerText = 'Online';

                const container = document.getElementById('service-list');

                services.forEach(s => {
                    // Unique ID for this service card
                    const cardId = `card-${s.name}`;
                    const existingCard = document.getElementById(cardId);

                    // CSS Logic
                    const activeClass = s.config.enabled ? 'active-dot' : '';
                    const cardBorder = s.config.enabled ? 'border-success' : 'border-secondary';
                    const cpuColor = s.cpu > s.config.target ? 'text-danger' : 'text-warning';

                    if (existingCard) {
                        // --- SMART UPDATE (Card exists, only update metrics) ---
                        
                        // Update Visuals
                        existingCard.className = `card ${cardBorder}`;
                        document.getElementById(`dot-${s.name}`).className = `status-dot ${activeClass} me-2`;
                        
                        // Update Metrics Text
                        document.getElementById(`rep-${s.name}`).innerText = s.replicas;
                        const cpuEl = document.getElementById(`cpu-${s.name}`);
                        cpuEl.innerText = s.cpu + "%";
                        cpuEl.className = cpuColor; // Flash red if high load

                        // CRITICAL: We DO NOT update the inputs (min/max/target) here.
                        // This allows you to type without it resetting.

                    } else {
                        // --- CREATE NEW (First time only) ---
                        const isEnabled = s.config.enabled ? 'checked' : '';
                        
                        const html = `
                        <div class="col-md-4 mb-3" id="wrapper-${s.name}">
                            <div class="card ${cardBorder}" id="${cardId}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="card-title mb-0">
                                            <span id="dot-${s.name}" class="status-dot ${activeClass} me-2"></span>${s.display}
                                        </h5>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enable-${s.name}" onchange="saveConfig('${s.name}')" ${isEnabled}>
                                        </div>
                                    </div>
                                    
                                    <div class="row text-center mb-3">
                                        <div class="col-6">
                                            <h3 class="text-info" id="rep-${s.name}">${s.replicas}</h3>
                                            <small>Replicas</small>
                                        </div>
                                        <div class="col-6">
                                            <h3 class="${cpuColor}" id="cpu-${s.name}">${s.cpu}%</h3>
                                            <small>CPU Load</small>
                                        </div>
                                    </div>

                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text bg-dark text-light">Min</span>
                                        <input type="number" class="form-control bg-dark text-light" id="min-${s.name}" value="${s.config.min}">
                                        <span class="input-group-text bg-dark text-light">Max</span>
                                        <input type="number" class="form-control bg-dark text-light" id="max-${s.name}" value="${s.config.max}">
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-dark text-light">Target %</span>
                                        <input type="number" class="form-control bg-dark text-light" id="target-${s.name}" value="${s.config.target}">
                                        <button class="btn btn-outline-primary" onclick="saveConfig('${s.name}')">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        container.insertAdjacentHTML('beforeend', html);
                    }
                });
            } catch (e) { 
                console.error(e);
                document.getElementById('conn-status').className = 'badge bg-danger';
                document.getElementById('conn-status').innerText = 'Offline';
            }
        }

        async function saveConfig(name) {
            const min = parseInt(document.getElementById(`min-${name}`).value);
            const max = parseInt(document.getElementById(`max-${name}`).value);
            const target = parseFloat(document.getElementById(`target-${name}`).value);
            const enabled = document.getElementById(`enable-${name}`).checked;

            // Simple visual feedback
            const btn = document.querySelector(`button[onclick="saveConfig('${name}')"]`);
            const originalText = btn.innerText;
            btn.innerText = "Saving...";

            try {
                await fetch(`/api/update/${name}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enabled, min, max, target })
                });
                
                // Force a reload to update border colors immediately
                await loadData();
                btn.innerText = "Saved!";
                setTimeout(() => btn.innerText = originalText, 1000);
            } catch (e) {
                alert("Error saving: " + e);
                btn.innerText = "Error";
            }
        }

        loadData();
        setInterval(loadData, 2000);
    </script>
</body>
</html>
